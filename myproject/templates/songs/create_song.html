{% extends 'base.html' %}

{% block title %}{% if is_english %}Create Song{% elif is_spanish %}Crear Canción{% elif is_german %}Lied erstellen{% elif is_portuguese %}Criar Música{% elif is_chinese %}创建歌曲{% else %}楽曲作成{% endif %} - UTAMEMO{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- ヘッダーセクション -->
            <div class="text-center mb-5 fade-in">
                <h1 class="display-6 fw-bold mb-3">{% if is_english %}Create Song{% elif is_spanish %}Crear Canción{% elif is_german %}Lied erstellen{% elif is_portuguese %}Criar Música{% elif is_chinese %}创建歌曲{% else %}楽曲を作成{% endif %}</h1>
                <p class="lead text-secondary">
                    {% if is_english %}
                    Generate learning songs from extracted text<br>
                    AI will automatically create optimal lyrics and melody
                    {% elif is_spanish %}
                    Genera canciones de aprendizaje a partir del texto extraído<br>
                    La IA creará automáticamente letras y melodías óptimas
                    {% elif is_german %}
                    Erzeuge Lernlieder aus extrahiertem Text<br>
                    KI erstellt automatisch optimale Texte und Melodien
                    {% elif is_portuguese %}
                    Gere músicas de aprendizado a partir de texto extraído<br>
                    A IA criará automaticamente letras e melodias otimizadas
                    {% elif is_chinese %}
                    从提取的文本生成学习歌曲<br>
                    AI将自动创建最佳歌词和旋律
                    {% else %}
                    抽出されたテキストから学習楽曲を生成<br>
                    AIが最適な歌詞とメロディーを自動作成
                    {% endif %}
                </p>
            </div>

            <!-- メインフォーム -->
            <div class="create-form-card fade-in">
                <div class="form-header">
                    <h3>{% if is_english %}AI Song Generation{% elif is_spanish %}Generación de Canciones con IA{% elif is_german %}KI-Liederstellung{% elif is_portuguese %}Geração de Música com IA{% elif is_chinese %}AI歌曲生成{% else %}AI楽曲生成{% endif %}</h3>
                    <p class="mb-0">{% if is_english %}Enter the information below to create your own learning song{% elif is_spanish %}Ingresa la información a continuación para crear tu propia canción de aprendizaje{% elif is_german %}Gib die Informationen unten ein, um dein eigenes Lernlied zu erstellen{% elif is_portuguese %}Insira as informações abaixo para criar sua própria música de aprendizado{% elif is_chinese %}输入以下信息，创建您的专属学习歌曲{% else %}以下の情報を入力して、あなただけの学習楽曲を作成しましょう{% endif %}</p>
                </div>
                
                {% if free_plan_limit_reached %}
                <!-- 無料プラン上限到達時 -->
                <div class="form-body">
                    <div class="text-center py-5">
                        <h4 class="fw-bold mb-3">
                            {% if is_english %}Monthly Limit Reached
                            {% elif is_spanish %}Límite Mensual Alcanzado
                            {% elif is_german %}Monatliches Limit Erreicht
                            {% elif is_portuguese %}Limite Mensal Atingido
                            {% elif is_chinese %}已达月度上限
                            {% else %}今月の作成上限に達しました
                            {% endif %}
                        </h4>
                        <p class="text-secondary mb-4">
                            {% if is_english %}You have used all 15 free songs this month.<br>Upgrade to create more songs!
                            {% elif is_spanish %}Has usado las 15 canciones gratuitas de este mes.<br>¡Actualiza para crear más canciones!
                            {% elif is_german %}Du hast alle 15 kostenlosen Lieder dieses Monats verbraucht.<br>Upgrade, um mehr Lieder zu erstellen!
                            {% elif is_portuguese %}Você usou todas as 15 músicas gratuitas deste mês.<br>Faça upgrade para criar mais músicas!
                            {% elif is_chinese %}您已使用完本月15首免费歌曲。<br>升级以创建更多歌曲！
                            {% else %}今月の無料枠15曲をすべて使い切りました。<br>アップグレードしてもっと楽曲を作成しましょう。
                            {% endif %}
                        </p>
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <a href="{% url 'users:upgrade' %}" class="btn btn-primary btn-lg px-4">
                                {% if is_english %}Upgrade Plan
                                {% elif is_spanish %}Mejorar Plan
                                {% elif is_german %}Plan Upgraden
                                {% elif is_portuguese %}Atualizar Plano
                                {% elif is_chinese %}升级计划
                                {% else %}プランをアップグレード
                                {% endif %}
                            </a>
                            <a href="{% url 'songs:my_songs' %}" class="btn btn-outline-secondary btn-lg px-4">
                                {% if is_english %}My Songs
                                {% elif is_spanish %}Mis Canciones
                                {% elif is_german %}Meine Lieder
                                {% elif is_portuguese %}Minhas Músicas
                                {% elif is_chinese %}我的歌曲
                                {% else %}マイ楽曲
                                {% endif %}
                            </a>
                        </div>
                        <p class="text-muted mt-4 small">
                            {% if is_english %}Free song count resets on {{ next_reset_date|date:"F j" }} ({{ days_until_reset }} days left).
                            {% elif is_spanish %}El conteo de canciones gratuitas se reinicia el {{ next_reset_date|date:"j \d\e F" }} ({{ days_until_reset }} días restantes).
                            {% elif is_german %}Der kostenlose Liederzähler wird am {{ next_reset_date|date:"j. F" }} zurückgesetzt (noch {{ days_until_reset }} Tage).
                            {% elif is_portuguese %}A contagem de músicas gratuitas será reiniciada em {{ next_reset_date|date:"j \d\e F" }} ({{ days_until_reset }} dias restantes).
                            {% elif is_chinese %}免费歌曲数量将在{{ next_reset_date|date:"n月j日" }}重置（还有{{ days_until_reset }}天）。
                            {% else %}無料枠は{{ next_reset_date|date:"n月j日" }}にリセットされます（あと{{ days_until_reset }}日）。
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% else %}
                <!-- 通常のフォーム表示 -->
                <div class="form-body">
                    <form method="post" id="create-song-form">
                        {% csrf_token %}
                        
                        <!-- タイトル入力 -->
                        <div class="form-group mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {% if is_english %}Song Title{% elif is_spanish %}Título de la Canción{% elif is_german %}Liedtitel{% elif is_portuguese %}Título da Música{% elif is_chinese %}歌曲标题{% else %}楽曲タイトル{% endif %} <span class="text-danger">*</span>
                            </label>
                            {{ form.title }}
                            <div class="form-text">{% if is_english %}Give it a memorable title that expresses the content{% elif is_spanish %}Dale un título memorable que exprese el contenido{% elif is_german %}Gib ihm einen einprägsamen Titel, der den Inhalt ausdrückt{% elif is_portuguese %}Dê um título memorável que expresse o conteúdo{% elif is_chinese %}取一个易于记忆且能表达内容的标题{% else %}覚えやすく、内容を表現するタイトルを付けましょう{% endif %}</div>
                            {% if form.title.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.title.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- ジャンル入力 -->
                        <div class="form-group mb-4">
                            <label for="{{ form.genre.id_for_label }}" class="form-label">
                                {% if is_english %}Music Genre{% elif is_spanish %}Género Musical{% elif is_german %}Musikgenre{% elif is_portuguese %}Gênero Musical{% elif is_chinese %}音乐类型{% else %}音楽ジャンル{% endif %}
                            </label>
                            {{ form.genre }}
                            <div class="form-text">
                                {% if is_english %}Select a genre that fits your learning content{% elif is_spanish %}Selecciona un género que se ajuste a tu contenido de aprendizaje{% elif is_german %}Wähle ein Genre, das zu deinem Lerninhalt passt{% elif is_portuguese %}Selecione um gênero que se adapte ao seu conteúdo de aprendizado{% elif is_chinese %}选择适合您学习内容的类型{% else %}学習内容に合ったジャンルを選択してください{% endif %}
                                <div class="genre-suggestions mt-2">
                                    {% if is_english %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">Auto</span>
                                    <span class="genre-tag" onclick="setGenre('Pop')">Pop</span>
                                    <span class="genre-tag" onclick="setGenre('Rock')">Rock</span>
                                    <span class="genre-tag" onclick="setGenre('Ballad')">Ballad</span>
                                    <span class="genre-tag" onclick="setGenre('Rap')">Rap</span>
                                    <span class="genre-tag" onclick="setGenre('Electronic')">Electronic</span>
                                    <span class="genre-tag" onclick="setGenre('Classical')">Classical</span>
                                    <span class="genre-tag" onclick="setGenre('Jazz')">Jazz</span>
                                    {% elif is_spanish %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">Auto</span>
                                    <span class="genre-tag" onclick="setGenre('Pop')">Pop</span>
                                    <span class="genre-tag" onclick="setGenre('Rock')">Rock</span>
                                    <span class="genre-tag" onclick="setGenre('Balada')">Balada</span>
                                    <span class="genre-tag" onclick="setGenre('Rap')">Rap</span>
                                    <span class="genre-tag" onclick="setGenre('Electrónica')">Electrónica</span>
                                    <span class="genre-tag" onclick="setGenre('Clásica')">Clásica</span>
                                    <span class="genre-tag" onclick="setGenre('Jazz')">Jazz</span>
                                    {% elif is_german %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">Auto</span>
                                    <span class="genre-tag" onclick="setGenre('Pop')">Pop</span>
                                    <span class="genre-tag" onclick="setGenre('Rock')">Rock</span>
                                    <span class="genre-tag" onclick="setGenre('Ballade')">Ballade</span>
                                    <span class="genre-tag" onclick="setGenre('Rap')">Rap</span>
                                    <span class="genre-tag" onclick="setGenre('Elektronisch')">Elektronisch</span>
                                    <span class="genre-tag" onclick="setGenre('Klassik')">Klassik</span>
                                    <span class="genre-tag" onclick="setGenre('Jazz')">Jazz</span>
                                    {% elif is_portuguese %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">Auto</span>
                                    <span class="genre-tag" onclick="setGenre('Pop')">Pop</span>
                                    <span class="genre-tag" onclick="setGenre('Rock')">Rock</span>
                                    <span class="genre-tag" onclick="setGenre('Balada')">Balada</span>
                                    <span class="genre-tag" onclick="setGenre('Rap')">Rap</span>
                                    <span class="genre-tag" onclick="setGenre('Eletrônica')">Eletrônica</span>
                                    <span class="genre-tag" onclick="setGenre('Clássica')">Clássica</span>
                                    <span class="genre-tag" onclick="setGenre('Jazz')">Jazz</span>
                                    {% elif is_chinese %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">自动</span>
                                    <span class="genre-tag" onclick="setGenre('流行')">流行</span>
                                    <span class="genre-tag" onclick="setGenre('摇滚')">摇滚</span>
                                    <span class="genre-tag" onclick="setGenre('抒情')">抒情</span>
                                    <span class="genre-tag" onclick="setGenre('说唱')">说唱</span>
                                    <span class="genre-tag" onclick="setGenre('电子')">电子</span>
                                    <span class="genre-tag" onclick="setGenre('古典')">古典</span>
                                    <span class="genre-tag" onclick="setGenre('爵士')">爵士</span>
                                    {% else %}
                                    <span class="genre-tag active" onclick="setGenre('Auto')">おまかせ</span>
                                    <span class="genre-tag" onclick="setGenre('ポップ')">ポップ</span>
                                    <span class="genre-tag" onclick="setGenre('ロック')">ロック</span>
                                    <span class="genre-tag" onclick="setGenre('バラード')">バラード</span>
                                    <span class="genre-tag" onclick="setGenre('ラップ')">ラップ</span>
                                    <span class="genre-tag" onclick="setGenre('電子音楽')">電子音楽</span>
                                    <span class="genre-tag" onclick="setGenre('クラシック')">クラシック</span>
                                    <span class="genre-tag" onclick="setGenre('ジャズ')">ジャズ</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if form.genre.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.genre.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- ボーカルスタイル選択 -->
                        <div class="form-group mb-4">
                            <label class="form-label">
                                {% if is_english %}Vocal Style{% elif is_spanish %}Estilo Vocal{% elif is_german %}Gesangsstil{% elif is_portuguese %}Estilo Vocal{% elif is_chinese %}声音性别{% else %}ボーカルの性別{% endif %} <span class="text-danger">*</span>
                            </label>
                            <div class="vocal-toggle-container">
                                <input type="radio" name="vocal_style" id="vocal-female" value="female" class="vocal-toggle-input" checked>
                                <input type="radio" name="vocal_style" id="vocal-male" value="male" class="vocal-toggle-input">
                                <div class="vocal-toggle-wrapper">
                                    <label for="vocal-female" class="vocal-toggle-btn">
                                        {% if is_english %}Female{% elif is_spanish %}Femenino{% elif is_german %}Weiblich{% elif is_portuguese %}Feminino{% elif is_chinese %}女声{% else %}女性{% endif %}
                                    </label>
                                    <label for="vocal-male" class="vocal-toggle-btn">
                                        {% if is_english %}Male{% elif is_spanish %}Masculino{% elif is_german %}Männlich{% elif is_portuguese %}Masculino{% elif is_chinese %}男声{% else %}男性{% endif %}
                                    </label>
                                </div>
                            </div>
                            {% if form.vocal_style.errors %}
                            <div class="text-danger mt-2">
                                <small>{% if is_english %}This field is required.{% elif is_spanish %}Este campo es obligatorio.{% elif is_german %}Dieses Feld ist erforderlich.{% elif is_portuguese %}Este campo é obrigatório.{% elif is_chinese %}此字段为必填项。{% else %}このフィールドは必須です。{% endif %}</small>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- AIモデル選択（有料プランのみ表示） -->
                        {% if user.is_starter or user.is_pro or user.is_school %}
                        <div class="form-group mb-4">
                            <label class="form-label">
                                <i class="bi bi-cpu me-1"></i>
                                {% if is_english %}Sound Quality{% elif is_spanish %}Calidad de Sonido{% elif is_german %}Klangqualität{% elif is_portuguese %}Qualidade de Som{% elif is_chinese %}音质{% else %}音質{% endif %}
                            </label>
                            <div class="model-selection-cards">
                                <!-- プレミアム (V8) -->
                                <label class="model-card {% if model_remaining.v8 == 0 %}disabled{% endif %}">
                                    <input type="radio" name="mureka_model" value="mureka-v8" {% if model_remaining.v8 != 0 %}checked{% endif %} {% if model_remaining.v8 == 0 %}disabled{% endif %}>
                                    <div class="model-card-content">
                                        <div class="model-name">{% if is_english %}Premium{% elif is_spanish %}Premium{% elif is_german %}Premium{% elif is_portuguese %}Premium{% elif is_chinese %}高级{% else %}プレミアム{% endif %}</div>
                                        <div class="model-remaining">
                                            {% if model_remaining.v8 == -1 %}
                                            <span class="unlimited"><i class="bi bi-infinity"></i> {% if is_english %}Unlimited{% elif is_spanish %}Ilimitado{% elif is_german %}Unbegrenzt{% elif is_portuguese %}Ilimitado{% elif is_chinese %}无限{% else %}無制限{% endif %}</span>
                                            {% elif model_remaining.v8 > 0 %}
                                            <span class="remaining">{% if is_english %}{{ model_remaining.v8 }} left{% elif is_spanish %}{{ model_remaining.v8 }} restantes{% elif is_german %}{{ model_remaining.v8 }} übrig{% elif is_portuguese %}{{ model_remaining.v8 }} restantes{% elif is_chinese %}剩余{{ model_remaining.v8 }}次{% else %}残り{{ model_remaining.v8 }}回{% endif %}</span>
                                            {% else %}
                                            <span class="depleted"><i class="bi bi-x-circle"></i> {% if is_english %}Limit reached{% elif is_spanish %}Límite alcanzado{% elif is_german %}Limit erreicht{% elif is_portuguese %}Limite atingido{% elif is_chinese %}已达上限{% else %}上限に達しました{% endif %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </label>
                                
                                <!-- 高音質 (O2) -->
                                <label class="model-card {% if model_remaining.o2 == 0 %}disabled{% endif %}">
                                    <input type="radio" name="mureka_model" value="mureka-o2" {% if model_remaining.v8 == 0 and model_remaining.o2 != 0 %}checked{% endif %} {% if model_remaining.o2 == 0 %}disabled{% endif %}>
                                    <div class="model-card-content">
                                        <div class="model-name">{% if is_english %}High Quality{% elif is_spanish %}Alta Calidad{% elif is_german %}Hohe Qualität{% elif is_portuguese %}Alta Qualidade{% elif is_chinese %}高音质{% else %}高音質{% endif %}</div>
                                        <div class="model-remaining">
                                            {% if model_remaining.o2 == -1 %}
                                            <span class="unlimited"><i class="bi bi-infinity"></i> {% if is_english %}Unlimited{% elif is_spanish %}Ilimitado{% elif is_german %}Unbegrenzt{% elif is_portuguese %}Ilimitado{% elif is_chinese %}无限{% else %}無制限{% endif %}</span>
                                            {% elif model_remaining.o2 > 0 %}
                                            <span class="remaining">{% if is_english %}{{ model_remaining.o2 }} left{% elif is_spanish %}{{ model_remaining.o2 }} restantes{% elif is_german %}{{ model_remaining.o2 }} übrig{% elif is_portuguese %}{{ model_remaining.o2 }} restantes{% elif is_chinese %}剩余{{ model_remaining.o2 }}次{% else %}残り{{ model_remaining.o2 }}回{% endif %}</span>
                                            {% else %}
                                            <span class="depleted"><i class="bi bi-x-circle"></i> {% if is_english %}Limit reached{% elif is_spanish %}Límite alcanzado{% elif is_german %}Limit erreicht{% elif is_portuguese %}Limite atingido{% elif is_chinese %}已达上限{% else %}上限に達しました{% endif %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </label>
                                
                                <!-- スタンダード (v7.6) -->
                                <label class="model-card {% if model_remaining.v7.6 == 0 %}disabled{% endif %}">
                                    <input type="radio" name="mureka_model" value="mureka-7.6" {% if model_remaining.v8 == 0 and model_remaining.o2 == 0 and model_remaining.v7.6 != 0 %}checked{% endif %} {% if model_remaining.v7.6 == 0 %}disabled{% endif %}>
                                    <div class="model-card-content">
                                        <div class="model-name">{% if is_english %}Standard{% elif is_spanish %}Estándar{% elif is_german %}Standard{% elif is_portuguese %}Padrão{% elif is_chinese %}标准{% else %}スタンダード{% endif %}</div>
                                        <div class="model-remaining">
                                            {% if model_remaining.v7.6 == -1 %}
                                            <span class="unlimited"><i class="bi bi-infinity"></i> {% if is_english %}Unlimited{% elif is_spanish %}Ilimitado{% elif is_german %}Unbegrenzt{% elif is_portuguese %}Ilimitado{% elif is_chinese %}无限{% else %}無制限{% endif %}</span>
                                            {% elif model_remaining.v7.6 > 0 %}
                                            <span class="remaining">{% if is_english %}{{ model_remaining.v7.6 }} left{% elif is_spanish %}{{ model_remaining.v7.6 }} restantes{% elif is_german %}{{ model_remaining.v7.6 }} übrig{% elif is_portuguese %}{{ model_remaining.v7.6 }} restantes{% elif is_chinese %}剩余{{ model_remaining.v7.6 }}次{% else %}残り{{ model_remaining.v7.6 }}回{% endif %}</span>
                                            {% else %}
                                            <span class="depleted"><i class="bi bi-x-circle"></i> {% if is_english %}Limit reached{% elif is_spanish %}Límite alcanzado{% elif is_german %}Limit erreicht{% elif is_portuguese %}Limite atingido{% elif is_chinese %}已达上限{% else %}上限に達しました{% endif %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% else %}
                        <!-- 無料プランはV8のみ（非表示で送信） -->
                        <input type="hidden" name="mureka_model" value="mureka-v8">
                        {% if free_plan_remaining is not None %}
                        <div class="form-group mb-4">
                            <div class="free-plan-remaining-info">
                                {% if is_english %}Free songs remaining this month: <strong>{{ free_plan_remaining }} / 15</strong>
                                {% elif is_spanish %}Canciones gratuitas restantes este mes: <strong>{{ free_plan_remaining }} / 15</strong>
                                {% elif is_german %}Verbleibende kostenlose Lieder diesen Monat: <strong>{{ free_plan_remaining }} / 15</strong>
                                {% elif is_portuguese %}Músicas gratuitas restantes este mês: <strong>{{ free_plan_remaining }} / 15</strong>
                                {% elif is_chinese %}本月剩余免费歌曲: <strong>{{ free_plan_remaining }} / 15</strong>
                                {% else %}今月の残り無料枠: <strong>{{ free_plan_remaining }} / 15曲</strong>
                                {% endif %}
                                <span class="free-plan-reset-date">
                                    {% if is_english %}Resets {{ next_reset_date|date:"F j" }}
                                    {% elif is_spanish %}Se restablece el {{ next_reset_date|date:"j \d\e F" }}
                                    {% elif is_german %}Zurücksetzung am {{ next_reset_date|date:"j. F" }}
                                    {% elif is_portuguese %}Redefinido em {{ next_reset_date|date:"j \d\e F" }}
                                    {% elif is_chinese %}{{ next_reset_date|date:"n月j日" }}重置
                                    {% else %}{{ next_reset_date|date:"n月j日" }}にリセット
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- カスタマイズ入力欄（自由記述） -->
                        <div class="form-group mb-4">
                            <label for="music_prompt" class="form-label">
                                <i class="bi bi-chat-dots me-1"></i>
                                {% if is_english %}Customize (Optional){% elif is_spanish %}Personalizar (Opcional){% elif is_german %}Anpassen (Optional){% elif is_portuguese %}Personalizar (Opcional){% elif is_chinese %}自定义（可选）{% else %}カスタマイズ（任意）{% endif %}
                            </label>
                            <textarea name="music_prompt" id="music_prompt" class="form-control custom-request-input" rows="2" 
                                placeholder="{% if is_english %}e.g. 'Make it upbeat', 'Add piano', 'Emotional ballad style', 'Like a J-pop song'{% elif is_spanish %}ej. 'Hazlo animado', 'Añade piano', 'Estilo balada emocional', 'Como una canción de J-pop'{% elif is_german %}z.B. 'Mach es fröhlich', 'Füge Klavier hinzu', 'Emotionaler Balladenstil', 'Wie ein J-Pop-Song'{% elif is_portuguese %}ex. 'Faça animado', 'Adicione piano', 'Estilo balada emocional', 'Como uma música de J-pop'{% elif is_chinese %}例如：'轻快一点'、'加钢琴'、'抒情风格'、'像日本流行歌曲'{% else %}例：「アップテンポで」「ピアノを入れて」「感動的なバラード調」「J-POPっぽく」{% endif %}"></textarea>
                            <small class="text-muted">
                                {% if is_english %}Tell AI how you want your song to sound{% elif is_spanish %}Dile a la IA cómo quieres que suene tu canción{% elif is_german %}Sag der KI, wie dein Lied klingen soll{% elif is_portuguese %}Diga à IA como você quer que sua música soe{% elif is_chinese %}告诉AI你想要什么样的歌曲{% else %}AIにどのような曲を作ってほしいか自由に伝えられます{% endif %}
                            </small>
                        </div>
                        
                        <!-- リファレンス曲（スターター以上） -->
                        <div class="form-group mb-4">
                            <label for="reference_song" class="form-label">
                                <i class="bi bi-music-note-beamed me-1"></i>
                                {% if is_english %}Reference Song (Optional){% elif is_spanish %}Canción de Referencia (Opcional){% elif is_german %}Referenzlied (Optional){% elif is_portuguese %}Música de Referência (Opcional){% elif is_chinese %}参考曲（可选）{% else %}リファレンス曲（任意）{% endif %}
                                {% if not user.is_starter %}
                                <span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-lock-fill"></i> {% if is_english %}Starter+{% elif is_spanish %}Starter+{% elif is_german %}Starter+{% elif is_portuguese %}Starter+{% elif is_chinese %}入门+{% else %}スターター以上{% endif %}
                                </span>
                                {% endif %}
                            </label>
                            {% if user.is_starter %}
                            <input type="text" name="reference_song" id="reference_song" class="form-control" 
                                placeholder="{% if is_english %}e.g. 'Lemon by Kenshi Yonezu', 'Shape of You style'{% elif is_spanish %}ej. 'Lemon de Kenshi Yonezu', 'Estilo Shape of You'{% elif is_german %}z.B. 'Lemon von Kenshi Yonezu', 'Shape of You Stil'{% elif is_portuguese %}ex. 'Lemon de Kenshi Yonezu', 'Estilo Shape of You'{% elif is_chinese %}例如：'米津玄师的Lemon'、'Shape of You风格'{% else %}例：「米津玄師のLemon」「Shape of You風」{% endif %}">
                            <small class="text-muted">
                                {% if is_english %}Enter a song or artist name to use as a style reference{% elif is_spanish %}Ingrese un nombre de canción o artista como referencia de estilo{% elif is_german %}Geben Sie einen Song- oder Künstlernamen als Stilreferenz ein{% elif is_portuguese %}Insira o nome de uma música ou artista como referência de estilo{% elif is_chinese %}输入歌曲或艺术家名称作为风格参考{% else %}スタイルの参考にする曲やアーティスト名を入力できます{% endif %}
                            </small>
                            {% else %}
                            <div class="locked-feature-box">
                                <i class="bi bi-lock-fill"></i>
                                <span>{% if is_english %}Upgrade to Starter plan to use reference songs{% elif is_spanish %}Actualiza al plan Starter para usar canciones de referencia{% elif is_german %}Upgrade auf Starter-Plan für Referenzlieder{% elif is_portuguese %}Atualize para o plano Starter para usar músicas de referência{% elif is_chinese %}升级到入门套餐以使用参考曲{% else %}スタータープランにアップグレードするとリファレンス曲を使用できます{% endif %}</span>
                                <a href="{% url 'users:upgrade' %}" class="btn btn-sm btn-outline-warning">{% if is_english %}Upgrade{% elif is_spanish %}Actualizar{% elif is_german %}Upgrade{% elif is_portuguese %}Atualizar{% elif is_chinese %}升级{% else %}アップグレード{% endif %}</a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 元テキスト（隠しフィールド） -->
                        <div style="display: none;">
                            {{ form.original_text }}
                        </div>
                        
                        <!-- 送信ボタン -->
                        {% if paid_plan_all_exhausted %}
                        <!-- 有料プラン全モデル上限到達アラート -->
                        <div class="limit-reached-alert mb-4">
                            <div class="limit-alert-content">
                                <strong>
                                    {% if is_english %}All model limits reached
                                    {% elif is_spanish %}Se alcanzaron los límites de todos los modelos
                                    {% elif is_german %}Alle Modell-Limits erreicht
                                    {% elif is_portuguese %}Todos os limites de modelos atingidos
                                    {% elif is_chinese %}所有模型已达上限
                                    {% else %}すべてのモデルが上限に達しました
                                    {% endif %}
                                </strong>
                                <p class="mb-1">
                                    {% if is_english %}Your monthly limit resets on {{ next_reset_date|date:"F j" }} ({{ days_until_reset }} days left).
                                    {% elif is_spanish %}Tu límite mensual se restablece el {{ next_reset_date|date:"j \d\e F" }} ({{ days_until_reset }} días restantes).
                                    {% elif is_german %}Dein monatliches Limit wird am {{ next_reset_date|date:"j. F" }} zurückgesetzt (noch {{ days_until_reset }} Tage).
                                    {% elif is_portuguese %}Seu limite mensal será redefinido em {{ next_reset_date|date:"j \d\e F" }} ({{ days_until_reset }} dias restantes).
                                    {% elif is_chinese %}您的月度限额将在{{ next_reset_date|date:"n月j日" }}重置（还有{{ days_until_reset }}天）。
                                    {% else %}月間の使用回数は{{ next_reset_date|date:"n月j日" }}にリセットされます（あと{{ days_until_reset }}日）。
                                    {% endif %}
                                </p>
                                <a href="{% url 'users:upgrade' %}" class="btn btn-sm btn-warning mt-1">
                                    {% if is_english %}Upgrade for more
                                    {% elif is_spanish %}Actualizar para más
                                    {% elif is_german %}Upgrade für mehr
                                    {% elif is_portuguese %}Atualize para mais
                                    {% elif is_chinese %}升级获取更多
                                    {% else %}アップグレードで回数を増やす
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        <div class="form-actions">
                            <button type="submit" class="btn-create-song {% if paid_plan_all_exhausted %}btn-disabled{% endif %}" {% if paid_plan_all_exhausted %}disabled{% endif %}>
                                {% if paid_plan_all_exhausted %}
                                <span class="btn-text">
                                    {% if is_english %}Limit Reached{% elif is_spanish %}Límite Alcanzado{% elif is_german %}Limit Erreicht{% elif is_chinese %}已达上限{% else %}上限に達しました{% endif %}
                                </span>
                                {% else %}
                                <span class="btn-text">{% if is_english %}Generate AI Song{% elif is_spanish %}Generar Canción con IA{% elif is_german %}KI-Lied generieren{% elif is_chinese %}AI生成歌曲{% else %}AI楽曲を生成{% endif %}</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="spinner-border spinner-border-sm"></span>
                                    {% if is_english %}Generating...{% elif is_spanish %}Generando...{% elif is_german %}Generiere...{% elif is_chinese %}生成中...{% else %}楽曲を生成中...{% endif %}
                                </span>
                                {% endif %}
                            </button>
                            <a href="{% url 'songs:upload_image' %}" class="btn-secondary-action">
                                {% if is_english %}Back to Upload{% elif is_spanish %}Volver a Subir{% elif is_german %}Zurück zum Hochladen{% elif is_chinese %}返回上传{% else %}画像アップロードに戻る{% endif %}
                            </a>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.create-form-card {
    background: var(--surface);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid rgba(255, 121, 64, 0.1);
}

.free-plan-remaining-info {
    background: linear-gradient(135deg, rgba(255, 121, 64, 0.08), rgba(255, 179, 71, 0.08));
    border: 1px solid rgba(255, 121, 64, 0.2);
    border-radius: var(--radius-lg, 12px);
    padding: 0.85rem 1.2rem;
    color: var(--text-primary);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.free-plan-reset-date {
    margin-left: auto;
    font-size: 0.82rem;
    color: var(--text-secondary, #888);
    white-space: nowrap;
}

/* 有料プラン全モデル上限到達アラート */
.limit-reached-alert {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.08), rgba(255, 166, 77, 0.08));
    border: 1px solid rgba(255, 107, 107, 0.3);
    border-radius: var(--radius-lg, 12px);
    padding: 1.25rem 1.5rem;
}

.limit-alert-content strong {
    display: block;
    margin-bottom: 0.35rem;
    color: var(--text-primary);
}

.limit-alert-content p {
    font-size: 0.88rem;
    color: var(--text-secondary, #888);
    margin-bottom: 0;
}

/* 無効化ボタン */
.btn-create-song.btn-disabled {
    background: var(--text-secondary, #888) !important;
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

.form-header {
    background: var(--primary-gradient);
    color: white;
    padding: 2rem;
    text-align: center;
}

.form-header h3 {
    margin-bottom: 0.5rem;
    font-weight: 700;
}

.form-body {
    padding: 2rem;
}

.form-group .form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 1rem;
    transition: all 0.3s ease;
    background: var(--surface);
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 121, 64, 0.1);
    background: var(--surface-elevated);
}

.form-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

.genre-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.genre-tag {
    padding: 0.25rem 0.75rem;
    background: var(--surface-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
}

.genre-tag:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-1px);
}

/* カスタマイズ入力欄 */
.custom-request-input {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    resize: none;
}

.custom-request-input:focus {
    border-color: #ff7940;
    box-shadow: 0 0 0 3px rgba(255, 121, 64, 0.1);
    outline: none;
}

.custom-request-input::placeholder {
    color: #aaa;
}

.privacy-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}

.privacy-header h6 {
    margin: 0;
    color: var(--text-primary);
}

.form-check-modern {
    margin-bottom: 1rem;
}

.form-check-modern input[type="checkbox"] {
    width: 1.5rem;
    height: 1.5rem;
    margin-right: 1rem;
    accent-color: var(--primary-color);
}

.form-check-modern .form-check-label {
    display: block;
    margin-left: 2.5rem;
    cursor: pointer;
}

.check-title {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.check-description {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.privacy-note {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: var(--radius-md);
    padding: 1rem;
    font-size: 0.9rem;
    color: #856404;
}

.success-alert {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}

.alert-title {
    font-weight: 700;
    color: #155724;
    margin-bottom: 0.25rem;
}

.alert-text {
    color: #155724;
    font-size: 0.9rem;
}

.form-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
}

.btn-create-song {
    background: var(--primary-gradient);
    border: none;
    color: white;
    padding: 1rem 3rem;
    border-radius: var(--radius-lg);
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-md);
    cursor: pointer;
    min-width: 250px;
    justify-content: center;
}

.btn-create-song:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.btn-create-song:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary-action {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary-action:hover {
    background: var(--surface-elevated);
    color: var(--primary-color);
    text-decoration: none;
}

/* ボーカルスタイル トグルボタン */
.vocal-toggle-container {
    position: relative;
}

.vocal-toggle-input {
    display: none;
}

.vocal-toggle-wrapper {
    display: inline-flex;
    background: #e8e8e8;
    border-radius: 8px;
    padding: 4px;
    gap: 2px;
}

.vocal-toggle-btn {
    padding: 10px 32px;
    font-size: 0.95rem;
    font-weight: 500;
    color: #666;
    background: transparent;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0;
}

.vocal-toggle-btn:hover {
    color: #444;
}

#vocal-female:checked ~ .vocal-toggle-wrapper label[for="vocal-female"],
#vocal-male:checked ~ .vocal-toggle-wrapper label[for="vocal-male"] {
    background: #fff;
    color: #333;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* アニメーション */
.fade-in {
    animation: fadeInUp 0.6s ease forwards;
}

.fade-in:nth-child(2) { animation-delay: 0.2s; }
.fade-in:nth-child(3) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* レスポンシブ調整 */
@media (max-width: 768px) {
    .form-header {
        padding: 1.5rem;
    }
    
    .form-body {
        padding: 1.5rem;
    }
    
    .genre-suggestions {
        justify-content: center;
    }
    
    .vocal-style-options {
        flex-direction: column;
    }
    
    .vocal-option {
        min-width: auto;
        width: 100%;
    }
    
    .form-check-modern .form-check-label {
        margin-left: 0;
        margin-top: 0.5rem;
    }
    
    .form-check-modern input[type="checkbox"] {
        margin-right: 0.5rem;
    }
    
    .btn-create-song {
        width: 100%;
        min-width: auto;
    }
}

/* ロックされた機能のスタイル */
.locked-feature-box {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px dashed #dee2e6;
    border-radius: 10px;
    color: #6c757d;
    font-size: 0.9rem;
}

.locked-feature-box i {
    color: #ffc107;
    font-size: 1.2rem;
}

.locked-feature-box .btn {
    margin-left: auto;
}

/* モデル選択カード */
.model-selection-cards {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.model-card {
    flex: 1;
    min-width: 140px;
    position: relative;
    cursor: pointer;
}

.model-card input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.model-card-content {
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    background: white;
    text-align: center;
    transition: all 0.2s ease;
}

.model-card input[type="radio"]:checked + .model-card-content {
    border-color: #ff7940;
    background: #fff8f5;
    box-shadow: 0 0 0 3px rgba(255, 121, 64, 0.1);
}

.model-card:hover .model-card-content {
    border-color: #ffb08c;
}

.model-card.disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.model-card.disabled .model-card-content {
    background: #f8f9fa;
}

.model-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.badge-starter {
    display: inline-block;
    background: linear-gradient(135deg, #ffc107, #ff9800);
    color: white;
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    vertical-align: middle;
}

.badge-premium {
    display: inline-block;
    background: linear-gradient(135deg, #9c27b0, #673ab7);
    color: white;
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    vertical-align: middle;
}

.model-remaining {
    font-size: 0.85rem;
}

.model-remaining .unlimited {
    color: #b8860b;
    font-weight: 700;
}

.model-remaining .remaining {
    color: #17a2b8;
}

.model-remaining .depleted {
    color: #dc3545;
}

@media (max-width: 576px) {
    .model-selection-cards {
        flex-direction: column;
    }
    
    .model-card {
        min-width: 100%;
    }
}
</style>

<script>
// ジャンル選択機能
function setGenre(genre) {
    document.getElementById('{{ form.genre.id_for_label }}').value = genre;
    
    // 視覚的フィードバック
    document.querySelectorAll('.genre-tag').forEach(tag => {
        tag.classList.remove('active');
    });
    event.target.classList.add('active');
}

// フォーム送信時の処理
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('create-song-form');
    const submitBtn = document.querySelector('.btn-create-song');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // プレースホルダーを言語に応じて変更
    const genreInput = document.getElementById('{{ form.genre.id_for_label }}');
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    
    {% if is_english %}
    if (genreInput) genreInput.placeholder = 'Genre (e.g. Pop, Rock, Classical)';
    if (titleInput) titleInput.placeholder = 'Enter the song title';
    {% elif is_spanish %}
    if (genreInput) genreInput.placeholder = 'Género (ej. Pop, Rock, Clásica)';
    if (titleInput) titleInput.placeholder = 'Ingrese el título de la canción';
    {% elif is_german %}
    if (genreInput) genreInput.placeholder = 'Genre (z.B. Pop, Rock, Klassik)';
    if (titleInput) titleInput.placeholder = 'Geben Sie den Liedtitel ein';
    {% elif is_chinese %}
    if (genreInput) genreInput.placeholder = '类型（例：流行、摇滚、古典）';
    if (titleInput) titleInput.placeholder = '输入歌曲标题';
    {% endif %}
    
    form.addEventListener('submit', function(e) {
        // ローディング状態に変更
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'flex';
        
        // 送信を続行
        return true;
    });
    
    // ジャンルタグにアクティブクラス追加のスタイル
    const currentGenre = genreInput.value;
    
    document.querySelectorAll('.genre-tag').forEach(tag => {
        if (tag.textContent.trim() === currentGenre) {
            tag.classList.add('active');
        }
    });
});

// CSS for active genre tag
const style = document.createElement('style');
style.textContent = `
    .genre-tag.active {
        background: var(--primary-color) !important;
        color: white !important;
        border-color: var(--primary-color) !important;
        transform: translateY(-1px);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}